{% load staticfiles %}
<!DOCTYPE html>
<html lang="en" manifest="{% url 'cbreak:appcache' %}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no">
 	<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
      <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	  <link rel="shortcut icon" href="{% static 'cbreak/favicon.ico' %}" type="image/x-icon">
	  <link rel="icon" href="{% static 'cbreak/favicon.ico' %}" type="image/x-icon">
	  <link rel="apple-touch-icon" sizes="58x58" href="{% static 'cbreak/appicon58.png' %}" />
	  <link rel="apple-touch-icon" sizes="72x72" href="{% static 'cbreak/appicon72.png' %}" />
	  <link rel="apple-touch-icon" sizes="76x76" href="{% static 'cbreak/appicon76.png' %}" />
	  <link rel="apple-touch-icon" sizes="114x114" href="{% static 'cbreak/appicon114.png' %}" />
	  <link rel="apple-touch-icon" sizes="120x120" href="{% static 'cbreak/appicon120.png' %}" />
	  <link rel="apple-touch-icon" sizes="144x144" href="{% static 'cbreak/appicon144.png' %}" />
	  <link rel="apple-touch-icon" sizes="152x152" href="{% static 'cbreak/appicon152.png' %}" />
	  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'cbreak/appicon180.png' %}" />
	  <!-- iPad retina portrait startup image -->
	<link href="{% static 'cbreak/startup-1536.png' %}"
	      media="(device-width: 768px) and (device-height: 1024px)
	             and (-webkit-device-pixel-ratio: 2)
	             and (orientation: portrait)"
	      rel="apple-touch-startup-image">
	<!-- iPad retina landscape startup image -->
	<link href="{% static 'cbreak/startup-2048.png' %}"
	      media="(device-width: 768px) and (device-height: 1024px)
	             and (-webkit-device-pixel-ratio: 2)
	             and (orientation: landscape)"
	      rel="apple-touch-startup-image">
	<!-- iPad non-retina portrait startup image -->
	<link href="{% static 'cbreak/startup-768.png' %}"
	      media="(device-width: 768px) and (device-height: 1024px)
	             and (-webkit-device-pixel-ratio: 1)
	             and (orientation: portrait)"
	      rel="apple-touch-startup-image">
	<!-- iPad non-retina landscape startup image -->
	<link href="{% static 'cbreak/startup-1024.png' %}"
	      media="(device-width: 768px) and (device-height: 1024px)
	             and (-webkit-device-pixel-ratio: 1)
	             and (orientation: landscape)"
	      rel="apple-touch-startup-image">
	<!-- iPhone 6 Plus portrait startup image -->
	<link href="{% static 'cbreak/startup-1242.png' %}"
	      media="(device-width: 414px) and (device-height: 736px)
	             and (-webkit-device-pixel-ratio: 3)
	             and (orientation: portrait)"
	      rel="apple-touch-startup-image">
	<!-- iPhone 6 Plus landscape startup image -->
	<link href="{% static 'cbreak/startup-2208.png' %}"
	      media="(device-width: 414px) and (device-height: 736px)
	             and (-webkit-device-pixel-ratio: 3)
	             and (orientation: landscape)"
	      rel="apple-touch-startup-image">
	<!-- iPhone 6 startup image -->
	<link href="apple-touch-startup-image-750x1294.png"
	      media="(device-width: 375px) and (device-height: 667px)
	             and (-webkit-device-pixel-ratio: 2)"
	      rel="apple-touch-startup-image">
	<!-- iPhone 5 startup image -->
	<link href="{% static 'cbreak/startup-640x.png' %}"
	      media="(device-width: 320px) and (device-height: 568px)
	             and (-webkit-device-pixel-ratio: 2)"
	      rel="apple-touch-startup-image">
	<!-- iPhone < 5 retina startup image -->
	<link href="{% static 'cbreak/startup-640.png' %}"
	      media="(device-width: 320px) and (device-height: 480px)
	             and (-webkit-device-pixel-ratio: 2)"
	      rel="apple-touch-startup-image">
	<!-- iPhone < 5 non-retina startup image -->
	<link href="{% static 'cbreak/startup-320.png' %}"
	      media="(device-width: 320px) and (device-height: 480px)
	             and (-webkit-device-pixel-ratio: 1)"
	      rel="apple-touch-startup-image">

	<meta name="apple-mobile-web-app-title" content="CaixaBreak">
     <title>CaixaBreak</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="{% static 'cbreak/css/bootstrap.min.css' %}">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="{% static 'cbreak/js/html5shiv.min.js' %}"></script>
      <script src="{% static 'cbreak/js/respond.min.js' %}"></script>
    <![endif]-->
  </head>
  <body>
  	<div class="container-fluid">
  		<div class="row">
			<div class="col-md-4 col-md-offset-4 col-xs-10 col-xs-offset-1" style="margin-top:60px;">
				<form class="form-horizontal" id="sendform" method="post">
					<input type="hidden" name="token" id="token">

					<div class="form-group">
						<input class="form-control" type="text" name="username" id="username" placeholder="Username" maxlength="7" pattern="[0-9]*">
					</div>

					<div class="form-group">
						<input class="form-control" type="password" name="password" id="password" placeholder="Password" maxlength="5">
					</div>

					<button class="btn btn-lg btn-block btn-primary" type="submit" id="daButton">Submit</button>
					<button class="btn btn-lg btn-block" type="button" id="leButt" style="display: none">Logout</button>
			  	</form>
			</div>
		</div>
		<div class="row">
			&nbsp;
		</div>
		<div class="row">
			<div class="col-md-8 col-md-offset-2" id="results">

			</div>
		</div>
  	</div>

	<div class="modal fade in" id="pleaseWaitDialog" tabindex="-1" role="dialog" aria-hidden="false" data-keyboard="false" data-backdrop="static">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-body">
	      	<h3 style='color: #777;'>Processing...</h3>
	        <div class="progress">
			  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
			  </div>
			</div>
	      </div>
	    </div>
	  </div>
	</div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="{% static 'cbreak/js/jquery.min.js' %}"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static 'cbreak/js/bootstrap.min.js' %}"></script>

    <script src="{% static 'cbreak/js/jquery.cookie.js' %}"></script>

	<script>
		function update_token(token) {
		    if (token) {
		    	$('#token').val(token);
		    	localStorage.token = token;
		    	$('#username').hide();
		    	$('#password').hide();
		    	$('#daButton').text('Refresh');
		    	$('#leButt').show();
		    }
		    else {
		    	$('#token').val('');
		    	localStorage.token = '';
		    	$('#username').show();
		    	$('#password').show();
		    	$('#daButton').text('Submit');
		    	$('#leButt').hide();
		    }
		};

		function update_info(balance, history) {
			var results = '<table class="table table-condensed">';
            results += '<tr><th scope="row">Balance</th><td colspan="2">' + balance + ' &euro;</td></tr>';
            results += '<tr><th scope="row" colspan="3">History</th></tr>';
            history.forEach(
            	function(a,b,c){
            		results += '<tr>'
	            	results += '<td>'
	            	results += a[0];
	            	results += '</td>'
	            	results += '<td>'
	            	results += a[1];
	            	results += '</td>'
	            	results += '<td>'
	            	results += a[3];
	            	results += ' &euro;</td>'
	            	results += '</tr>'
	            	results += '<tr>'
	            	results += '<td colspan ="3">'
	            	results += a[2];
	            	results += '</td>'
	            	results += '</tr>'
            	});
	        results += '</table>';
            $('#results').html(results);
		};

		$('#leButt').click(function(){
			$('#results').html(null);
			update_token('');
		});

		$('#username').val($.cookie('izbreak_username'));
		update_token(localStorage.token);

		if (localStorage.token) {
			update_info(localStorage.balance, JSON.parse(localStorage.history));
		}

		// variable to hold request
		var request;

		// bind to the submit event of our form
		$("#sendform").submit(function(event) {
			event.preventDefault();

		    // abort any pending request
		    if (request) {
		        request.abort();
		    }
	    	$.cookie('izbreak_username',$('#username').val(), { expires: 99999 });
		    // setup some local variables
		    var $form = $(this);
		    // serialize the data in the form
		    var serializedData = $form.serialize();

		    $('#pleaseWaitDialog').modal();

		    // fire off the request to /form.php
		    request = $.ajax({
		        url: "{% url 'cbreak:info' %}",
		        type: "post",
		        data: serializedData
		    });

	      	request.fail(function(xhr, textStatus, error) {
	      		$('#pleaseWaitDialog').modal('hide');
			    alert(
			        "The following error occured: " +
			        error
			    );
	      	});

		    // callback handler that will be called on success
		    request.done(function (response, textStatus, jqXHR){
		    	$('#pleaseWaitDialog').modal('hide');
		        if (!response['success']) {
		        	alert(response['error']);
		        	update_token('');
		        }
		        else {
		        	if (response['token']) {
		        		update_token(response['token']);
		        	};

		        	update_info(response['balance'], response['history']);
		        	localStorage.balance = response['balance'];
		        	localStorage.history = JSON.stringify(response['history']);
		        };
		    });
		});
	</script>
</body>
</html>
